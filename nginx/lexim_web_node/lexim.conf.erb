keepalive_timeout   70;
client_max_body_size 4G;
server_name golexim.com;

if ($http_x_forwarded_proto = http) { rewrite ^ https://$host$1; } # permanent; }

root /www/lexim/current/public;

proxy_set_header  X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header Host $http_host;
proxy_redirect off;

if ($host = 'www.golexim.com' ) {
  rewrite  ^/(.*)$  http://golexim.com/$1  permanent;
}

recursive_error_pages on;

if (-f $document_root/system/maintenance.html) {
  set $maint M;
}

location /health/check {
  if (-f $document_root/system/maintenance.html) {
    return 200;
  }

  proxy_pass http://unicorn_server;
}

if ($maint = M) {
  return 503;
}

error_page 503 @503;
location @503 {
  error_page 405 = /system/maintenance.html;

  # Serve static assets if found.
  if (-f $request_filename) {
    break;
  }

  rewrite ^(.*)$ /system/maintenance.html break;
}

try_files $uri/index.html $uri.html $uri @app;
location @app {
  proxy_pass http://unicorn_server;
}

error_page 404 /404.html;
location = /404.html {
  root /www/lexim/current/public;
}